---
title: "Get Started with glydet"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Get Started with glydet}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

Glycan derived traits are summary features calculated from individual glycan abundances.
Instead of analyzing every single glycan structure,
we combine related glycans into biologically meaningful groups.
For example, traits describing the overall level of galactosylation, sialylation, fucosylation, or branching.
These derived traits capture broader patterns in glycosylation and reduce noise from individual measurements.

Compared with analyzing raw glycan abundances (the "direct traits"),
using derived traits has several advantages.
It simplifies the data while keeping key biological information,
making it easier to interpret and compare across samples.
Derived traits also tend to be more robust and less affected by technical variation,
and they can better highlight biological trends or associations with phenotypes.
In short, derived traits help us see the forest rather than just the trees üå≤üå≤üå≤.

Enter `glydet` üöÄ‚Äîyour toolkit for calculating derived traits with unprecedented precision.
But here's where it gets exciting:
`glydet` brings the power of derived traits to the glycoproteomics community for the first time,
enabling **site-specific trait analysis**.
Plus, it features an intuitive domain-specific language that lets you define custom traits tailored to your research needs.

## Important Notes Before You Start

### Prerequisites

This package is built on the [glyrepr](https://github.com/glycoverse/glyrepr) package,
and heavily relies on the [glyexp](https://github.com/glycoverse/glyexp) package.
If you are not familiar with these two packages,
we highly recommend checking out their introductions first.
Also, to fully understand the concepts and functions in this package,
it is recommended to have a basic understanding of the [glymotif](https://github.com/glycoverse/glymotif) package.

### Data Types

`glydet` is designed to work with untargeted glycomics and glycoproteomics data.
Label-free quantification data is readily supported by `glyread` and `glyclean`.
For labeling quantification like TMT, ratios between the target and reference channels (TMT ratios)
must be converted to abundance matrix following this procedure:

1. Calculate the median of all reference channel MS2 summed intensities from the unnormalized intensity matrix for each glycopeptide
2. Multiply the TMT ratios by the median MS2 summed intensities for each glycopeptide

This enables the quantification of different glycopeptides in the same sample to be comparable.

## üéØ Dive Right In: Your First Analysis

```{r setup}
library(glydet)
library(glyrepr)
library(glyexp)
library(glyclean)
library(glystats)
```

Ready to see `glydet` in action?
Let's jump straight into a real-world example that demonstrates its power!
We'll work with `glyexp::real_experiment` ‚Äî 
an authentic N-glycoproteomics dataset from 12 patients with varying liver conditions. 

‚ö†Ô∏è **Pro tip:** Always preprocess your data with `glyclean` before diving into trait analysis.
This ensures your results are as clean and reliable as your data!

```{r}
exp <- auto_clean(real_experiment)  # Preprocess the data
exp
```

Let's take a quick peek at our dataset to understand what we're working with:

```{r}
get_var_info(exp)
```

```{r}
get_sample_info(exp)
```

```{r}
get_expr_mat(exp)[1:5, 1:5]
```

Now for the magic moment ‚ú®‚Äîlet's calculate some derived traits!

```{r}
trait_exp <- derive_traits(exp)
trait_exp
```

Voil√†! What you see is a brand new `experiment()` object with "traitomics" type.
Think of it as your original dataset's sophisticated cousin üé≠ ‚Äî
instead of tracking "quantification of each glycan on each glycosite in each sample,"
it now contains "the value of each derived trait on each glycosite in each sample."

```{r}
get_var_info(trait_exp)
```

```{r}
# These are the trait values!
get_expr_mat(trait_exp)[1:5, 1:5]
```

üéâ **Congratulations!** You've just calculated a comprehensive suite of derived traits in a site-specific manner:

- **`TM`**: Proportion of high-mannose glycans
- **`TH`**: Proportion of hybrid glycans  
- **`TC`**: Proportion of complex glycans
- **`MM`**: Average number of mannoses within high-mannose glycans
- **`CA2`**: Proportion of bi-antennary glycans within complex glycans
- **`CA3`**: Proportion of tri-antennary glycans within complex glycans
- **`CA4`**: Proportion of tetra-antennary glycans within complex glycans
- **`TF`**: Proportion of fucosylated glycans
- **`TFc`**: Proportion of core-fucosylated glycans
- **`TFa`**: Proportion of arm-fucosylated glycans
- **`TB`**: Proportion of glycans with bisecting GlcNAc
- **`GS`**: Average degree of sialylation per galactose
- **`AG`**: Average degree of galactosylation per antenna
- **`TS`**: Proportion of sialylated glycans

üí° **The key insight:** We treat the glycans on each glycosite as a separate mini-glycome,
then calculate derived traits for each one across all samples.
For instance, if a particular glycosite hosts 10 different glycans,
the `TFc` value represents the proportion of core-fucosylated glycans within those 10 structures in each sample.

**Important Note:** All built-in derived traits only work for N-glycans.
For other types of glycans, you need to define your own derived traits.
Check out the [Defining Custom Traits](https://glycoverse.github.io/glydet/articles/custom-traits.html) vignette
to learn how to define your own derived traits.
In fact, for other types of glycans not so complex as N-glycans, e.g. O-glycans,
we recommend using [motif quantification](https://glycoverse.github.io/glydet/articles/quantify-motifs.html) instead.

Now comes the fun part!
üìä You can leverage all the powerful functions in the `glystats` package to analyze your derived traits.
Let's demonstrate with an ANOVA analysis to identify glycosites with significantly different levels of core-fucosylation across conditions:

```{r}
anova_res <- gly_anova(trait_exp)
anova_res$tidy_result$main_test |>
  dplyr::filter(trait == "TFc", p_adj < 0.05)
```

üîç **Discovery time!** We've identified several glycosites with statistically significant differences
in core-fucosylation levels across our patient groups ‚Äî
exactly the kind of biological insights that make derived traits so powerful!

## üîß Under the Hood: Understanding Meta-Properties

Curious about how the magic happens?
Let's lift the hood and explore `glydet`'s inner workings‚Äîbut don't worry,
we'll keep things accessible! 

The key concept you need to understand is **"meta-properties"** -
think of them as the molecular fingerprints of individual glycans.

üÜö **What's the difference?**

- **Derived traits** describe entire glycomes (or all glycans on a glycosite) and their values fluctuate across samples
- **Meta-properties** describe individual glycans regardless of their abundance ‚Äî
like counting antennae,core fucoses, or sialic acids on a single structure

üß† **The connection:** Meta-properties are the building blocks for derived traits.
When you call `derive_traits()`,
`glydet` automatically calculates meta-properties for all glycans first,
then uses this information to compute the derived traits you see.

Want to work with meta-properties directly? üõ†Ô∏è You're in luck! `glydet` provides two handy functions:

- **`get_meta_properties()`**: Calculate meta-properties for any set of glycans
- **`add_meta_properties()`**: Enrich your `experiment()` object by adding meta-properties to variable information

### üî¨ get_meta_properties()

Let's see `get_meta_properties()` in action!
We'll extract a few glycan structures from our dataset:

```{r}
glycans <- unique(get_var_info(exp)$glycan_structure)[1:5]
glycans
```

üìù **Note:** `glycans` is a `glyrepr::glycan_structure()` vector‚Äîthese are standardized representations of glycan structures.

Now watch the magic happen as we calculate their meta-properties:

```{r}
get_meta_properties(glycans)
```

### üìà add_meta_properties()

Working with `glyexp::experiment()` objects? Perfect!
You can supercharge your variable information by adding meta-properties directly:

```{r}
exp_with_mp <- add_meta_properties(exp)
get_var_info(exp_with_mp)
```

‚ú® **Look at that transformation!** Your variable information is now enriched with multiple meta-property columns.
This opens up powerful filtering possibilities based on structural features. 

For instance, let's filter for all glycoforms containing high-mannose glycans:

```{r}
exp_with_mp |>
  filter_var(Tp == "highmannose")
```

### üß∞ Meta-Property Functions: Your Structural Toolkit

Behind the scenes, meta-properties are actually functions that take `glyrepr::glycan_structure()` vectors
and return corresponding property values.
`glydet` comes packed with a comprehensive library of built-in meta-property functions:

```{r}
names(all_mp_fns())
```

üìö **Your complete toolkit:** Here's the full roster of built-in meta-property functions:

| Name | Function | Description |
|------|----------|-------------|
| `Tp` | `n_glycan_type()` | Type of the glycan, either "complex", "hybrid", "highmannose", or "pausimannose" |
| `B` | `has_bisecting()` | Whether the glycan has a bisecting GlcNAc |
| `nA` | `n_antennae()` | Number of antennae |
| `nF` | `n_fuc()` | Number of fucoses |
| `nFc` | `n_core_fuc()` | Number of core fucoses |
| `nFa` | `n_arm_fuc()` | Number of arm fucoses |
| `nG` | `n_gal()` | Number of galactoses |
| `nGt` | `n_terminal_gal()` | Number of terminal galactoses |
| `nS` | `n_sia()` | Number of sialic acids |
| `nM` | `n_man()` | Number of mannoses |

Each function can be called directly for quick structural analysis:

```{r}
n_glycan_type(glycans)
```

## üß© Working with Structural Ambiguity

An important design principle of `glydet` is its ability to handle glycan structures with varying levels of detail.
All built-in meta-properties and derived traits are designed to work with the **minimum information typically available**
for N-glycans in most experimental scenarios.

### üîß Generic vs. Specific Monosaccharides

`glydet` works seamlessly with generic monosaccharide names (e.g., "Hex", "HexNAc", "dHex") and structures lacking linkage information.
This level of structural resolution reflects what is commonly achievable in glycoproteomics workflows,
where complete structural determination is often challenging.

For example, this ambiguous structure works perfectly:

```{r}
# Generic monosaccharides with unknown linkages ‚ùì
ambiguous_glycan <- "HexNAc(??-?)Hex(??-?)[Hex(??-?)]Hex(??-?)HexNAc(??-?)[dHex(??-?)]HexNAc(??-"
```

### ‚ú® Handling Detailed Structures 

This design philosophy doesn't limit `glydet`'s applicability to well-characterized structures.
The package equally handles glycans with complete structural information:

```{r}
# Fully specified structure with specific monosaccharides and linkages ‚úÖ
detailed_glycan <- "GlcNAc(b1-2)Man(a1-3)[Man(a1-6)]Man(b1-3)GlcNAc(b1-4)[Fuc(a1-6)]GlcNAc(b1-"
```

### üöÄ Extending Functionality

When working with highly detailed structural information,
you may want to create specialized meta-property functions that leverage specific monosaccharide identities or linkage patterns.
This allows you to define custom derived traits that capture structural features beyond the generic framework provided by the built-in functions.

## Working with Glycomics Data

Working with glycomics data has no difference from working with glycoproteomics data,
even more straightforward as the resulting `experiment()` has a simpler structure.
Here we briefly demonstrate how to work with glycomics data using `glyexp::real_experiment2`.

```{r}
exp <- auto_clean(real_experiment2)
trait_exp <- derive_traits(exp)
trait_exp
```

## What's Next?

Now you have a good understanding of `glydet` and how to use it.
You can try `all_traits()` to calculate more advanced and detailed derived traits.
You can also start to define your own meta-property functions and derived traits.
Check out the [Custom Traits](https://glycoverse.github.io/glydet/articles/custom-traits.html) vignette
to learn how to define your own derived traits.
Or you can check out a special type of derived traits:
[motif quantification](https://glycoverse.github.io/glydet/articles/quantify-motifs.html).